<p align="right">
<a href="https://autorelease.general.dmz.palantir.tech/palantir/godel-conjure-plugin"><img src="https://img.shields.io/badge/Perform%20an-Autorelease-success.svg" alt="Autorelease"></a>
</p>

godel-conjure-plugin
====================
godel-conjure-plugin is a [godel](https://github.com/palantir/godel) plugin for [conjure-go](https://github.com/palantir/conjure-go/).
The plugin runs conjure-go based on project configuration. It also runs as part of the `--verify` task and verifies that
the running the task would not alter the content of the output directory.

Tasks
-----
* `conjure`: runs Conjure generation. Runs for all of the entries specified in the configuration in order. The working
  directory is set to be the project directory.
* `conjure-publish`: publishes IR to a specified destination.

Verify
------
When run as part of verification that does not apply, the task fails if running the task would alter any of the contents
of the output directory. The output directory will not be modified as part of this process. Note that the implementation
operates by temporarily making a copy of the output directory. For this reason, one should avoid having large files in
the output directory.

Config
------
The configuration for this plugin is in a file called `conjure-plugin.yml`. The configuration should be of the following
form:

```yaml
version: 1
projects:
  project-1:
    output-dir: outputDir
    ir-locator: local/conjure-yaml-files
  project-2:
    output-dir: outputDir
    ir-locator: https://host.com/conjure-ir-file.json
```

The top-level `projects` is a map where the key is the name of the Conjure task and the value is the
configuration for that task. `output-dir` specifies the base directory into which the output is written. The
`ir-locator` parameter specifies how the IR should be retrieved.

IR locators can specify a local Conjure YAML file, a local directory that contains Conjure YAML files (in which case the
IR generated by the input YAML files is used), a URL that points to a Conjure IR file or a local file that specifies
Conjure IR.

If the locator is specified as a string, its target is determined as follows:
* If it starts with a URL scheme ("http://", "https://", etc.), it is considered to be a URL
* If the specified path exists and is a file, it is assumed to be a Conjure IR file
* Otherwise, it is assumed to be a Conjure YAML directory

If the inference rules above are not sufficient, then the locator type can be specified explicitly. For example,
"localhost:8080/ir.json" will not be inferred to be a remote IR provider because it does not start with a scheme. In
order to be used as a remote provider, the type must be specified explicitly:

```yaml
version: 1
projects:
  project-1:
    output-dir: outputDir
    ir-locator:
      type: remote
      locator: localhost:8080/ir.json
```

The supported types are `remote`, `yaml` and `ir-file`.

Publish
-------
The `conjure-publish` task publishes Conjure IR to a location based on the provided arguments. The Conjure IR files that
can be published are determined based on the projects defined in `conjure-projects` block. By default, YAML locator types
are considered as possible to publish (because publish workflow most commonly publish IR generated from local YAML).
However, `publish: true` can be set on a project explicitly to allow it to publish its IR.

The `publish` command uses the Git versioner of [`distgo`](https://github.com/palantir/distgo) to determine the version
for the IR and uses distgo's Artifactory publisher to publish the IR to an Artifactory destination.

Here is an example invocation to publish a Conjure definition:

```
./godelw conjure-publish --group-id=com.palantir.test-group --url https://artifactory.com --repository "$PUBLISH_REPO" --username "$ARTIFACTORY_USERNAME" --password "$ARTIFACTORY_PASSWORD"
```

The `--dry-run` flag can be added to print the operation that would be performed (including the upload URL).

Assets
======

Currently, `godel-conjure-plugin` only supports assets for a single use case: **adding extensions to the Conjure IR that gets published**. This mechanism allows external executables (assets) to programmatically provide additional key-value pairs that will be merged into the `extensions` block of the Conjure IR during the publish process.

### Asset Requirements

An asset must satisfy the following requirements to be recognized and invoked by `godel-conjure-plugin`:

1. **_assetInfo Probe**:
When the asset is executed with the single argument `_assetInfo`, it must output the following JSON to stdout:
```json
{ "type": "<ASSET_TYPE>" }
```
The only `ASSET_TYPE` that is currently supported is  `"conjure-ir-extensions-provider"`.
If the asset does not output this exact type, it will not be used as an extensions provider.

2. **Single-Argument Invocation**:
The asset will only ever be invoked with a single command-line argument: a JSON-encoded object that is hard coded with the key value pairs specified [here](https://github.com/palantir/godel-conjure-plugin/blob/df2fa3c6cf515848c444446c4df22054ee01c8fe/internal/extensions-provider/provider.go#L101-L108).
If the asset is invoked with more than one argument, it must immediately fail.
Any arguements sent to the asset should be sent via the JSON blob argument.

3. **Extensions Response**:
When invoked with the JSON blob, the asset should output a valid JSON object to stdout.
Each key-value pair in this object will be merged into the `extensions` block of the Conjure IR.
If the output is not a valid JSON object, `godel-conjure-plugin` will fail.

4. **Key Overwrites**:
If multiple assets provide the same keys, **last write wins** will be applied.
The order in which assets are invoked is **indeterminate** and should not be relied upon for key precedence.

### Example: Minimally Viable `conjure-ir-extensions-provider` Asset

Below is an example of a minimal shell asset that satisfies all requirements.

```sh
#!/bin/sh

# Fail if not exactly one argument
if [ "$#" -ne 1 ]; then
    exit 1
fi

# Respond to the _assetInfo probe
if [ "$1" = "_assetInfo" ]; then
    printf '%s\n' '{ "type": "conjure-ir-extensions-provider" }'
    exit 0
fi

# Otherwise, output an empty object (no extensions)
printf '%s\n' '{}'
exit 0
```

This asset will:
- Respond to `_assetInfo` with the required JSON and type.
- Accept only a single argument (the JSON blob).
- Output an empty extensions object when invoked during publishing.